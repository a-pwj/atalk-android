buildscript {
    repositories {
        google()
        jcenter()
    }

    dependencies {
        // working jarjar.repackage version
        classpath "org.anarres.jarjar:jarjar-gradle:1.0.1"
    }
}

plugins {
    id 'base'
}

repositories {
    google()
    jcenter()
    maven {
        url 'https://oss.sonatype.org/content/repositories/snapshots'
    }
}

apply plugin: 'org.anarres.jarjar'

def smackVersion = '4.4.0-alpha3-SNAPSHOT'

def jarJarDeps = task("jarJarDeps") {
    doFirst {
        println "Fixed dependencies"
    }
}

/*
 * jarjar.repackage with generated dir/filename specified - default in build/jarjar/jarjar-xxx.jar
 * destinationDir may use relative i.e. "../../libs to $buildDir/jarjar or as per below
 * filename must not contains colon i.e. ":" colon, treated as URL and will failed missing classes
 * classDelete must check actual jar to see if end ** is required - due to multiple components
 * May use className and className$** to delete only the related, but excluding classes with same prefix
 */
jarJarDeps.dependsOn(
    jarjar.repackage {
        from("org.igniterealtime.smack:smack-core:$smackVersion") {
            transitive = false
        }
        destinationDir new File("${projectDir}/../aTalk/third_party/m2/org/igniterealtime/smack/smack-core-jarjar/${smackVersion}")
        destinationName "smack-core-jarjar-${smackVersion}.jar"

        // smack-core
        classDelete 'org.jivesoftware.smack.provider.AbstractProvider'
        classDelete 'org.jivesoftware.smack.util.StringUtils**'
        classDelete 'org.jivesoftware.smack.AbstractXMPPConnection**'
    },

    jarjar.repackage {
        from("org.igniterealtime.smack:smack-experimental:$smackVersion") {
            transitive = false
        }
        destinationDir new File("${projectDir}/../aTalk/third_party/m2/org/igniterealtime/smack/smack-experimental-jarjar/${smackVersion}")
        destinationName "smack-experimental-jarjar-${smackVersion}.jar"

        // smack-experimental
        classDelete 'org.jivesoftware.smackx.httpfileupload.HttpFileUploadManager**'
    },

    jarjar.repackage {
        from("org.igniterealtime.smack:smack-extensions:$smackVersion") {
            transitive = false
        }
        destinationDir new File("${projectDir}/../aTalk/third_party/m2/org/igniterealtime/smack/smack-extensions-jarjar/${smackVersion}")
        destinationName "smack-extensions-jarjar-${smackVersion}.jar"

        // smack-extensions
        classDelete 'org.jivesoftware.smackx.bytestreams.ibb.InBandBytestreamManager**'
        classDelete 'org.jivesoftware.smackx.bytestreams.ibb.InBandBytestreamSession**'
        classDelete 'org.jivesoftware.smackx.chatstates.ChatStateManager**'
        classDelete 'org.jivesoftware.smackx.filetransfer.IBBTransferNegotiator**'
        classDelete 'org.jivesoftware.smackx.filetransfer.FaultTolerantNegotiator'
        classDelete 'org.jivesoftware.smackx.muc.MultiUserChat**'
    }

/*
    jarjar.repackage {
        from("org.igniterealtime.smack:smack-tcp:$smackVersion") {
            transitive = false
        }
        destinationDir new File("${projectDir}/../aTalk/third_party/m2/org/igniterealtime/smack/smack-tcp-jarjar/${smackVersion}")
        destinationName "smack-tcp-jarjar-${smackVersion}.jar"

        // smack-tcp
        classDelete 'org.jivesoftware.smack.tcp.XmppNioTcpConnection**'
        classDelete 'org.jivesoftware.smack.tcp.XMPPTCPConnection**'
    }
*/
)
tasks.getByName("build").dependsOn(jarJarDeps)